---
title: "The Effect of COVID-19 on Global Temperature and Greenhouse Gas Atmospheric Concentration: an EDA Approach"
author: "Saurav Kiri, Logan Patterson, Aaron Spielman, Sujit Sivadanam"
date: '`r format(Sys.time(), "Last modified: %d %b %Y")`'
output:
    bookdown::gitbook:
        pandoc_args: ["--lua-filter", "figure_caption_patch.lua"]
        code_folding: hide
        self_contained: true
        split_by: none
        sharing: null
bibliography: "munging_climate_change.bib"
csl: "bmc-genomics.csl"
link-citations: TRUE
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
library(tidyverse)
library(data.table)
library(corrplot) # Make correlation plots
#install.packages("ComplexHeatmap")##Logan-"This package isn't available for my version of R.Anyone else having this issue?
library(ComplexHeatmap) # For making heatmaps
library(ggfortify)      # For using autoplot() with prcomp()
library(ClusterR)       # For k-means clustering
library(factoextra)     # For elbow plots to determine optimal k and k-NN vis
library(FNN)            # For using get.knn to find k-nearest neighbors of years
library(kableExtra)
library(plotly)         # Required for making plots interactive
library(DT)             # Required to make interactive datatable
library(ggcorrplot)
library(cowplot)

load("setup.RData")
```

# Background
Coronavirus disease 2019 (COVID-19), caused by the SARS-CoV-2 virus, was declared as a [public health emergency of international concern](https://www.who.int/publications/m/item/covid-19-public-health-emergency-of-international-concern-(pheic)-global-research-and-innovation-forum) on January 30, 2020, and later as a pandemic on March 11 2020 by the World Health Organization (WHO). The announcement of the pandemic lead to widespread lockdowns, reduced travel, and decreased energy usage. To date, the WHO still considers COVID-19 to be an ongoing pandemic, with over [640 million cases reported worldwide](https://covid19.who.int).

The effects of COVID-19 have permeated all aspects of society--including our contributions to climate change. For example, during the core 2020 lockdown period, weekly global CO<sub>2</sub> emissions were decreased relative to 2019, with an associated 6.4% decrease in CO<sub>2</sub> emissions compared to the year prior [@tollefson_covid_2021]. A report from 2020 indicated 50% of the world's population decreased their travel activity by at least 50% at the beginning of the pandemic in April, which coincided with up to a 30% decrease in nitrogen oxide (NO/NO<sub>2</sub>) emissions for this month [@forster_current_2020]. Nitrogen oxide emissions in East China dropped by an average of about 50% during the initial lockdown period (January 23 - February 9) as compared to the 22 days prior [@zhang_nox_2020]. While recent reports have illustrated the resurgence of greenhouse gas emissions following the relaxing of restrictions, it is clear that the COVID-19 lockdown had a positive impact on climate change, if only temporarily.

Given the many scientific and news reports on the effect of lockdowns on the environment (including this popular report covering the water in the canals of Venice, Italy [running clear during lockdown](https://www.cnbc.com/2020/03/18/photos-water-in-venice-italys-canals-clear-amid-covid-19-lockdown.html)), we were interested in making our own investigation into changes of environmental markers during COVID-19, with the goal of answering the question: **is there a noticeable change in greenhouse gas concentrations and global temperature during the COVID-19 period as compared to other years?** We defined the COVID-19 window as **December 2019 - July 2021** for this purpose; December 2019 was when the first reported case of COVID occurred, and July 2021 is approximately when [half the U.S. population had been vaccinated at least once](https://usafacts.org/visualizations/covid-vaccine-tracker-states).

To answer this question, we acquired monthly average [global greenhouse gas concentration data from NOAA](https://gml.noaa.gov/ccgg/trends/) for the following gases:

1. Methane (CH<sub>4</sub>), emitted prominently from landfills, mining, and energy usage facilities
2. Nitrous oxide (N<sub>2</sub>O), a byproduct of industrial activities
3. Sulfur hexafluoride (SF<sub>6</sub>), used widely in the electricity industry for insulation

Additionally, monthly average global temperature anomaly data was acquired from the [NASA GIS surface temperature analysis](https://data.giss.nasa.gov/gistemp/), consisting of 3 total datasets, each for the same period of years:

1. Temperature anomalies from AIRS (Atmospheric InfraRed Sounder) v6
2. Temperature anomalies from AIRS v7
3. Temperature anomalies from GHCN (Global Historical Climatology Network) v4

Relationships between years were analyzed by clustering, heatmaps, and moving average plots; trends were observed and predicted with simple linear models. See Section \@ref(about-the-data) to learn more about the data, and Section \@ref(about-the-data) to see how the data was wrangled and assessed prior to visualization/EDA.

# About the Data
## Downloading and Filtering
Data were downloaded from NOAA as 3 fixed-width .txt files; one per gas. Data from NASA was contained in a single .csv file, consisting of the 3 separate datasets (anomalies recorded by each of the above instrumentation/software) split by separator strings.

NOAA data contains information encoded by the following fields (~ 1980 - present): 1) year, 2) month, 3) date in decimal, 4) average monthly gas concentration in mole fraction (parts per), 5) average uncertainty (a standard error measurement performed by NOAA), 6) trend in mole fraction, and 7) standard error of the trend.

NASA data contains information encoded as temperature anomaly in degrees C. For each month of each year (2002 - present), the difference in that month's average temperature from the average temperature of that month during the period 2006 - 2017. Positive anomalies indicate the temperature was warmer than a long-term average; temperature anomalies are favored over absolute temperature for comparative analysis as they can more accurately capture variation of temperature across long durations of time, and are normalized to some frame of reference.

Since both data files contained extraneous textual information, the terminal-based text stream parsing program `awk` was used to filter the data as follows:

```
# NOAA data
awk '{if ($1 > 2002) print $0}' "${name}.txt" > "${name}-filtered.txt"

# NASA data
awk '/Global.*/{n++}{print > "nasa_gistemp_" n ".csv"}' ${FILENAME}
```

The former command will only save data from 2002 to the present; 2002 was chosen since NASA temperature data only goes back to 2002, and consistency among datasets was desired for the final output. The latter command splits the NASA GISTEMP parent .csv into 3, R-friendly .csv files.

## Data Wrangling
Our interest was in investigating the properties of data in the COVID window (12/2019 - 07/2021) as compared to previous windows of comparable time. Since the long-term effect of COVID-19 on climate change is considered insignificant, we were hopeful that by choosing similar window "control" sizes, we could compare the short-term effects of COVID within a concentrated window to similar time periods. In effect, since we chose to deal with more granular time points, we did not want to necessarily smooth out the variation of previous years in, say, a 5-year average, as this would result in differences in the distributions of data being compared. This scheme was used for some, but not all, exploratory analysis. Therefore, a list of lists of data frames from the data was created in which each sub-list consisted of data frames for one dataset (e.g., one sublist for methane data, one sublist for nitrous oxide, etc.), and each sublist was a list of data frames broken up by year in 20-month windows:

* December 2003 - July 2005
* December 2005 - July 2007
* ...
* December 2019 - July 2021


Structure of the original data; note that null values were encoded as "-9.99" for NOAA data and in asterisks (\*\*\*\*\*) for NASA data; these were converted to NA prior to analysis. Additionally, original NASA data was in "wide" format; in order to be able to create Date objects to construct time-series plots, data was pivoted to long format (shown below).
```{r, eval = FALSE}
##### Code from setup.r file

# Set up top-level project directory
# Note that this assumes one of the following:
    #1) You have cloned the git repo with git clone
    #2) You have a file system as defined in the GitHub repository
        # I.e., similar to ~/Project/Datasets and ~/Project/Scripts

# Code from https://stackoverflow.com/questions/47044068/
getCurrentFileLocation <-  function() {
    this_file <- commandArgs() %>%
    tibble::enframe(name = NULL) %>%
    tidyr::separate(col = value,
                    into = c("key", "value"),
                    sep = "=",
                    fill = "right") %>%
    dplyr::filter(key == "--file") %>%
    dplyr::pull(value)
    if (length(this_file) == 0) {
        this_file <- rstudioapi::getSourceEditorContext()$path
    }
    return(dirname(this_file))
}

# Alternative is to use here() (from "here" package)
    # Walks up dir hierarchy starting from wd during loading until it finds a dir satisfying either:
    # 1) Contains file matching [.]Rproj$
    # 2) Contains a .git directory
# Disadvantage is that it only works if you're in a directory *within* root

# Get directory of current file, which should be in Scripts sub-dir
current.dir <- file.path(getCurrentFileLocation())
setwd(current.dir)
setwd("../")    # The directory immediately above should be project root
rm(current.dir)

# Setup project, scripts, and data directories
project.dir <- getwd()
scripts.dir <- "Scripts"
data.dir <- "Datasets"

# Set directory to datasets
setwd(file.path(project.dir, data.dir))

# Source import and wrangle files
source(file.path(project.dir, scripts.dir, "importdata.r"))
source(file.path(project.dir, scripts.dir, "gas_temp_wrangle.r"))

# Read in data
gas.data <- read_gas_data()
temp.data <- read_temp_data()
```

```{r}
###### Code from the .r files called by setup.r script
#-----Importing NOAA greenhouse gas data-----#
# Used awk (see filtergas.sh) to pre-filter NOAA greenhouse gas data for 2003 - present

read_gas_data <- function() {
    # Get list of gases of interest for which we have data
    gas.list <- c("ch4", "n2o", "sf6")
    gas.files <- lapply(gas.list, function(x) list.files(path = ".", pattern = paste0(x, ".*filtered\\.txt")))

    # Read files into df list
    gas.data <- lapply(gas.files, fread)
    names(gas.data) <- gas.list

    # CH4 is in ppm, N2O is in ppb, SF6 is in ppt - rename all colnames just to ppb first
    gas.colnames <- c("Year",
                    "Month",
                    "Year_Day_decimal",
                    "Average_ppb",
                    "Uncertainty_avg",
                    "Trend",
                    "Uncertainty_trend")
    gas.data <- lapply(gas.data, function(x) setNames(x, gas.colnames))

    # Now rename colnames for ch4 and sf6 
    ppb.col <- which(gas.colnames == "Average_ppb")
    colnames(gas.data$ch4)[ppb.col] <- "Average_ppm"
    colnames(gas.data$sf6)[ppb.col] <- "Average_ppt"
    return(gas.data)
}

#-----Importing NASA GISTEMP data-----#
# Used awk (see parsetemp.sh) to split the files into 3 sub-csv files

read_temp_data <- function() {
    temp.files <- list.files(path = ".", pattern = "nasa_gistemp_[123][.]csv")

    # Read files into df list - skip first line, which is string description
    temp.data <- lapply(temp.files, function(x) read.csv(x, skip = 1, header = TRUE))
    names(temp.data) <- c("airsv6", "airsv7", "ghcnv4")
    return(temp.data)
}

```


```{r class.source = "fold-show"}
# First 4 rows of each data frame
for (list.obj in list(gas.data, temp.data)) {
    for (df in list.obj) {
        print(head(df, n = 4L))
    }
}
```


Structure of the wrangled data, with lists of lists:
```{r}
# Moving window function, which will subset a df into a list of dfs by desired month cycle
df_window_subset <- function(df, init.year.wind = 2003, wind.size = 2, final.init.year = 2019) {
    moving.dfsub.list <- list()
    while (init.year.wind <= final.init.year) {
        end.year.wind <- init.year.wind + wind.size
        # Filter for only years in the current window
        # Then filter for only December, year X to Jul, year X + 2
        moving.df <- df %>%
                        filter(Year >= init.year.wind & Year <= end.year.wind) %>%
                        filter(!((Year == init.year.wind & Month < 12) | (Year == end.year.wind & Month > 7)))
        moving.dfsub.list[[paste(init.year.wind, end.year.wind, sep = "-")]] <- as.data.frame(moving.df)
        init.year.wind <- init.year.wind + wind.size
    }
    return(moving.dfsub.list)
}

# Adds a column of Date objects to a df from cols named Year and Month. Assumes day is constant (1 by default)
add_date_col <- function(df, day = 1) {
    df <- df %>% mutate(Date = as.Date(paste(Year, Month, day, sep = "-"),
                                       format = "%Y-%m-%d"))
    return(df)
}

tempdata.convert.na <- function(data.list) {
    # For each data frame of temp.data, take each column and replace ***** with NA
    data.list.na <- lapply(data.list,
                        function(df) as.data.frame(lapply(df, function(x) as.numeric(gsub(x, pattern = "\\*.*",
                                                                                     replacement = NA)))))
    return(data.list.na)
}

wrangle_tempdata <- function(temp.data) {
    # Need to convert asterisk values to NA in order to convert the data to long format
    # pivot_longer() cannot combine columns that are of diff atomic types
    # Use defined tempdata.convert.na above to accomplish this
    temp.data.na <- tempdata.convert.na(temp.data)

    # Convert data to long format to allow for date-based time series plot
    temp.data.long <- lapply(temp.data.na, function(df) df %>%
                            pivot_longer(cols = "Jan":"Dec",
                                         names_to = "Month",
                                         values_to = "Temp_diff"))

    # Converting month abbv to numeric
    # Use data.table::set() to modify col j of the df in place for use in lapply - avoids requiring for loop
    # Sets the value of col j to that given by the value argument
    lapply(temp.data.long, function(df) set(df, j = "Month", value = match(df$"Month", month.abb)))

    # Add Date object column for time series analysis
    temp.data.date <- lapply(temp.data.long, add_date_col)

    # For each data frame in temp.data.long, create the windowed subset df
    # This produces for each df, a list of sub-dfs
    # Sub-dfs can be indexed by, e.g., list$airsv6$"2003-2005"
    windowed.df.list <- lapply(temp.data.date, df_window_subset)
    return(windowed.df.list)
}

gasdata.convert.na <- function(data.list) {
    # Use replace_with_na() from  packagenaniar to replace values of -9.99 with NA
    # See https://cran.r-project.org/web/packages/naniar/vignettes/replace-with-na.html
    if (!require(naniar)) {
        install.packages("naniar", quietly = TRUE)
    }
    data.list.na <- lapply(data.list, function(df) df %>%
                            replace_with_na(replace = list(Uncertainty_avg = -9.99,
                                                           Uncertainty_trend = -9.99)))
    return(data.list.na)
}

wrangle_gasdata <- function(gas.data) {
    # Replace -9.99 values with NA using gasdata.convert.na() function above
    gas.data.na <- gasdata.convert.na(gas.data)
    gas.data.date <- lapply(gas.data.na, add_date_col)
    gas.data.windowed.list <- lapply(gas.data.date, df_window_subset)
    return(gas.data.windowed.list)
}

gas.data.windowed.dfs <- wrangle_gasdata(gas.data)
temp.data.windowed.dfs <- wrangle_tempdata(temp.data)
```

############################## Added by Logan (data initialization) ##########################################
```{r}
# Moving window function, which will subset a df into a list of dfs by 1 year increments
df_window_subset_full <- function(df, init.year.wind = 2003, wind.size = 1, final.init.year = 2021) {
  moving.dfsub.list <- list()
  while (init.year.wind <= final.init.year) {
    end.year.wind <- init.year.wind + wind.size
    # Filter for only years in the current window
    moving.df <- df %>%
      filter(Year >= init.year.wind & Year < end.year.wind) 
    moving.dfsub.list[[paste(init.year.wind)]] <- as.data.frame(moving.df)
    init.year.wind <- init.year.wind + wind.size
  }
  return(moving.dfsub.list)
}

wrangle_gasdata_full <- function() {
  # Use replace_with_na() from  packagenaniar to replace values of -9.99 with NA
  # See https://cran.r-project.org/web/packages/naniar/vignettes/replace-with-na.html
  if (!require(naniar)) {
    install.packages("naniar", quietly = TRUE)
  }
  gas.data.na <- lapply(gas.data, function(df) df %>% 
                          replace_with_na(replace = list(Uncertainty_avg = -9.99,
                                                         Uncertainty_trend = -9.99)))
  gas.data.date <- lapply(gas.data.na, add_date_col)
  gas.data.windowed.list <- lapply(gas.data.date, df_window_subset_full)
  return(gas.data.windowed.list)
}
```


```{r, class.source = "fold-show", results = "hold"}
# Only a few data frames are shown here for convenience
head(gas.data.windowed.dfs$ch4$"2003-2005")
tail(gas.data.windowed.dfs$ch4$"2003-2005")

head(temp.data.windowed.dfs$airsv7$"2019-2021")
tail(temp.data.windowed.dfs$airsv7$"2019-2021")
```


## Quality Assessment
Below are some summarized results of the quality assessment performed on the data prior to downstream analysis.

```{r, results = "hold"}
# Column completeness
col_complete <- function(dataframe){
  if(!is.data.frame(dataframe)){
    stop("the object is not a dataframe")
  }
  
  missing_count <- 0
  for(j in 1:ncol(dataframe)){
    for(i in 1:nrow(dataframe)){
      if(is.na(dataframe[i, j])){missing_count <- missing_count+1}
    }
  }
  complete_ratio <- 1 - missing_count/(nrow(dataframe)*ncol(dataframe))
  return(complete_ratio)
}

library(visdat)
library(naniar)
library(tidyverse)

# Analyzing for completeness
col_complete(temp.data.converted$airsv6)
col_complete(temp.data.converted$airsv7)
col_complete(temp.data.converted$ghcnv4)

# Analyzing for completeness
col_complete(as.data.frame(gas.data.converted$ch4))
col_complete(as.data.frame(gas.data.converted$n2o))
col_complete(as.data.frame(gas.data.converted$sf6))
```

```{r, results = "hold", fig.cap = "Various plots indicating data quality of acquired climate change data"}
# Representative plots for analyzing missingness and outliers
vis_miss(temp.data.converted$airsv6)
vis_miss(as.data.frame(gas.data.converted$ch4))
airsv6 <- airsv6 <- subset(temp.data.converted$airsv6, select = -Year)
airsv7 <- subset(temp.data.converted$airsv7, select = -Year)

airsv6 %>%
    select(1:12) %>%
    boxplot()

airsv7 %>%
    select(1:12) %>%
    boxplot()
```

The ratios of column completeness for both the "airsv6" and "airsv7" datasets are both identically the same (0.9573935) while the ratio of column completeness for the "ghcnv4" dataset was just a bit higher (0.9899749) than the other two. In other words, the datasets are almost complete in that the few missing values are not of significant concern. All three of the temp datsets are consistent in terms of precision. Most missing values are found in 2002 (for AIRS v6 and AIRS v7), indicating data collection for this software type had likely not started yet.

In the "airsv6" dataset, the months of January, May, June, & November each have one outlier. In the "airsv7" dataset, January, March, & June each have one outlier while November has five outliers.

For the gas data, the ratios of column completeness for all three data sets (ch4, n2o, sf6) are each 0.9927052, which is very good because these few missing values won't have a significant effect on the data analysis. These missing values are also all for the final months of 2022 - simply indicating the dataset had not yet been updated as data collection and aggregation is likely still ongoing. Furthermore, each column of each of the three datasets are consistently precise. In terms of outliers, the "ch4" dataset has the most outliers (not shown for simplicity).

# Exploratory Data Analysis - Plots and Commentary

########################################## Added By Logan (dataframes) ##########################################
```{r}
#introduce dataset from gas_temp_wrangler.r file function
gases <- wrangle_gasdata() #Windowed (change to df_window_subset function)
gases_full <- wrangle_gasdata_full() #Contiguous (change to df_window_subset_full function)
#head(gases)
# View(gases$sf6)
#View(gases_full)
# View(gases_full$sf6$`2021`)
#-------------------Dataframe Initialization----------------------

##########convert data to subsetted Dataframes########
#sf6.df <- as.data.frame(gases$sf6)<- for horizontal data
big.sf6 <- bind_rows(gases$sf6)

#ch4.df <- as.data.frame(gases$ch4)<- for horizontal data
big.ch4 <- bind_rows(gases$ch4)

#n2o.df <- as.data.frame(gases$n2o)<- for horizontal data
big.n2o <- bind_rows(gases$n2o)

#########convert data to contiguous Dataframes########

#sf6_full.df <- as.data.frame(gases_full$sf6) <- for horizontal data
big.sf6_full <- bind_rows(gases_full$sf6)

#ch4.df_full <- as.data.frame(gases_full$ch4) <- for horizontal data
big.ch4_full <- bind_rows(gases_full$ch4)

#n2o.df_full <- as.data.frame(gases_full$n2o) <- for horizontal data
big.n2o_full <- bind_rows(gases_full$n2o)

################Combine the Dataframes#########################

for (i in 1:length(big.sf6)) {
  big.sf6$gas <- "sf6"
}

for (i in 1:length(big.ch4)) {
  big.ch4$gas <- "ch4"
}

for (i in 1:length(big.n2o)) {
  big.n2o$gas <- "n2o"
}

big.gas <- rbind(big.ch4, big.n2o, big.sf6)

#Joined Time Series (contiguous)
for (i in 1:length(big.sf6_full)) {
  big.sf6_full$gas <- "sf6"
}

for (i in 1:length(big.ch4_full)) {
  big.ch4_full$gas <- "ch4"
}

for (i in 1:length(big.n2o_full)) {
  big.n2o_full$gas <- "n2o"
}

big.gas_full <- rbind(big.ch4_full, big.n2o_full, big.sf6_full)

```

In order to get a general sense for trends among the gas data, we can look at simple time series plots. 

```{r, class.source = "fold-show", fig.cap = "Time Series for Atmospheric SF6, CH4, and N2O"}
#----------------------------Time Series ---------------------------------
#############Generate plots for each gas####################
#sf6 time series

tmp <- data.frame(rectangle_x = c(big.sf6_full[big.sf6_full$Date=="2019-12-01", "Date"], 
                                   big.sf6_full[big.sf6_full$Date=="2019-12-01", "Date"],
                                   max(big.sf6_full$Date),
                                   max(big.sf6_full$Date)),
                  rectangle_y = c(-Inf, 
                                   Inf,
                                   Inf,
                                   -Inf))

sf6.plot <- ggplot(big.sf6_full, aes(x = Date, y = Average_ppb)) +
        geom_area(fill="#69b3a2", alpha=0.5) + 
        geom_line(color = "#69b3a2") +
        geom_polygon(data = tmp, aes(x = rectangle_x, y = rectangle_y), 
               fill = "red", 
               alpha = .3,
               linetype = "dashed") +
        scale_x_date(date_breaks = "12 months", date_labels = "%Y %b %d") +
        theme(axis.text.x=element_text(angle=60, hjust=1)) +
        geom_vline(linetype = 4, xintercept = as.numeric(big.sf6_full[big.sf6_full$Date=="2019-12-01", "Date"]), color = "red") +
        ggtitle("SF6 Concentration From 2003 - 2021") +
        annotate("text", 
             x = big.sf6_full[big.sf6_full$Date=="2019-08-01", "Date"],
             y = .006,
             label = "First Reported Case of COVID-19",
             angle = 90,
             size = 4)

#sf6.plot
sf6_ly <- ggplotly(sf6.plot)

#ch4 time series
tmp <- data.frame(rectangle_x = c(big.ch4_full[big.ch4_full$Date=="2019-12-01", "Date"], 
                                  big.ch4_full[big.ch4_full$Date=="2019-12-01", "Date"],
                                  max(big.ch4_full$Date),
                                  max(big.ch4_full$Date)),
                  rectangle_y = c(-Inf, 
                                  Inf,
                                  Inf,
                                  -Inf))

ch4.plot <- ggplot(big.ch4_full, aes(x = Date, y = Average_ppb)) +
  geom_area(fill="orange", alpha=0.5) + 
  geom_line(color = "orange") +
  geom_polygon(data = tmp, aes(x = rectangle_x, y = rectangle_y), 
               fill = "red", 
               alpha = .3,
               linetype = "dashed") +
  scale_x_date(date_breaks = "12 months", date_labels = "%Y %b %d") +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  geom_vline(linetype = 4, xintercept = as.numeric(big.ch4_full[big.ch4_full$Date=="2019-12-01", "Date"]), color = "red") +
  ggtitle("CH4 Concentration From 2003 - 2021") +
  annotate("text", 
           x = big.ch4_full[big.ch4_full$Date=="2019-09-01", "Date"],
           y = 1000000,
           label = "First Reported Case of COVID-19",
           angle = 90,
           size = 4)

#ch4.plot
ch4_ly <- ggplotly(ch4.plot)

#n2o time series
tmp <- data.frame(rectangle_x = c(big.n2o_full[big.n2o_full$Date=="2019-12-01", "Date"], 
                                  big.n2o_full[big.n2o_full$Date=="2019-12-01", "Date"],
                                  max(big.n2o_full$Date),
                                  max(big.n2o_full$Date)),
                  rectangle_y = c(-Inf, 
                                  Inf,
                                  Inf,
                                  -Inf))

n2o.plot <- ggplot(big.n2o_full, aes(x = Date, y = Average_ppb)) +
  geom_area(fill="blue", alpha=0.5) + 
  geom_line(color = "blue") +
  geom_polygon(data = tmp, aes(x = rectangle_x, y = rectangle_y), 
               fill = "red", 
               alpha = .3,
               linetype = "dashed") +
  scale_x_date(date_breaks = "12 months", date_labels = "%Y %b %d") +
  theme(axis.text.x=element_text(angle=60, hjust=1)) +
  geom_vline(linetype = 4, xintercept = as.numeric(big.n2o_full[big.n2o_full$Date=="2019-12-01", "Date"]), color = "red") +
  ggtitle("N2O Concentration From 2003 - 2021") +
  annotate("text", 
           x = big.n2o_full[big.n2o_full$Date=="2019-08-01", "Date"],
           y = 150,
           label = "First Reported Case of COVID-19",
           angle = 90,
           size = 4)

#n2o.plot
n2o_ly <- ggplotly(n2o.plot)

#ggplots
plot_grid(sf6.plot, ch4.plot, n2o.plot)
#plotlys 
sf6_ly
ch4_ly
n2o_ly

```  

At a glance, the time series don't suggest that there was much of a trend difference before or after the pandemic. Note that the y-xis scaling for each gas is different, so what's more important here is the rate of change across time. SF6 seemed to show the fastest rate of change, and all 3 plots show a general upward trend in gas concentrations.

Let's break up the series into COVID-length (~20 months) windows:

```{r, class.source = "fold-show", fig.cap = "Windowed Time Series"}

#########################Time Series by Covid Length Blocks#####################

#SF6-------------
block1 <- as.data.frame(gases$sf6$'2003-2005')
block2 <- as.data.frame(gases$sf6$'2005-2007')
block3 <- as.data.frame(gases$sf6$'2007-2009')
block4 <- as.data.frame(gases$sf6$'2009-2011')
block5 <- as.data.frame(gases$sf6$'2011-2013')
block6 <- as.data.frame(gases$sf6$'2013-2015')
block7 <- as.data.frame(gases$sf6$'2015-2017')
block8 <- as.data.frame(gases$sf6$'2017-2019')
block9 <- as.data.frame(gases$sf6$'2019-2021')

time.blocks <- list(block1,
                 block2,
                 block3,
                 block4,
                 block5,
                 block6,
                 block7,
                 block8,
                 block9)

str(time.blocks)

block_list <- list()
for (i in time.blocks){
  new_element <- ggplot(i, aes(x = Date, y = Average_ppb)) +
    geom_line(color = "blue") +
    scale_x_date(date_breaks = "6 months", date_labels = "%Y %b %d") +
    theme(axis.text.x=element_text(angle=0, hjust=1))
  
  block_list[[length(block_list) + 1]] <- new_element
  
}
 
block_list
block.names <- list('SF6 Concentrations for 2003-2005',
                    'SF6 Concentrations for 2005-2007',
                    'SF6 Concentrations for 2007-2009',
                    'SF6 Concentrations for 2009-2011',
                    'SF6 Concentrations for 2011-2013',
                    'SF6 Concentrations for 2013-2015',
                    'SF6 Concentrations for 2015-2017',
                    'SF6 Concentrations for 2017-2019',
                    'SF6 Concentrations for 2019-2021')

ggarrange(plotlist = block_list,
          ncol = 3, nrow = 3, 
          labels = block.names,
          hjust = -.2555,
          vjust = 1.5)

#CH4--------------
block1 <- as.data.frame(gases$ch4$'2003-2005')
block2 <- as.data.frame(gases$ch4$'2005-2007')
block3 <- as.data.frame(gases$ch4$'2007-2009')
block4 <- as.data.frame(gases$ch4$'2009-2011')
block5 <- as.data.frame(gases$ch4$'2011-2013')
block6 <- as.data.frame(gases$ch4$'2013-2015')
block7 <- as.data.frame(gases$ch4$'2015-2017')
block8 <- as.data.frame(gases$ch4$'2017-2019')
block9 <- as.data.frame(gases$ch4$'2019-2021')

time.blocks <- list(block1,
                    block2,
                    block3,
                    block4,
                    block5,
                    block6,
                    block7,
                    block8,
                    block9)

#str(time.blocks)

block_list <- list()
for (i in time.blocks){
  new_element <- ggplot(i, aes(x = Date, y = Average_ppb)) +
    geom_line(color = "blue") +
    scale_x_date(date_breaks = "1 months", date_labels = "%b") +
    theme(axis.text.x=element_text(angle=0, hjust=1))
  
  block_list[[length(block_list) + 1]] <- new_element
  
}

block.names <- list('CH4 Concentrations for 2003-2005',
                    'CH4 Concentrations for 2005-2007',
                    'CH4 Concentrations for 2007-2009',
                    'CH4 Concentrations for 2009-2011',
                    'CH4 Concentrations for 2011-2013',
                    'CH4 Concentrations for 2013-2015',
                    'CH4 Concentrations for 2015-2017',
                    'CH4 Concentrations for 2017-2019',
                    'CH4 Concentrations for 2019-2021')

ggarrange(plotlist = block_list,
          ncol = 3, nrow = 3, 
          labels = block.names,
          hjust = -.2555,
          vjust = 1.5)


#N2O----------
block1 <- as.data.frame(gases$n2o$'2003-2005')
block2 <- as.data.frame(gases$n2o$'2005-2007')
block3 <- as.data.frame(gases$n2o$'2007-2009')
block4 <- as.data.frame(gases$n2o$'2009-2011')
block5 <- as.data.frame(gases$n2o$'2011-2013')
block6 <- as.data.frame(gases$n2o$'2013-2015')
block7 <- as.data.frame(gases$n2o$'2015-2017')
block8 <- as.data.frame(gases$n2o$'2017-2019')
block9 <- as.data.frame(gases$n2o$'2019-2021')

time.blocks <- list(block1,
                    block2,
                    block3,
                    block4,
                    block5,
                    block6,
                    block7,
                    block8,
                    block9)

#str(time.blocks)

block_list <- list()
for (i in time.blocks){
  new_element <- ggplot(i, aes(x = Date, y = Average_ppb)) +
    geom_line(color = "blue") +
    scale_x_date(date_breaks = "1 months", date_labels = "%b") +
    theme(axis.text.x=element_text(angle=0, hjust=1))
  
  block_list[[length(block_list) + 1]] <- new_element
  
}

block.names <- list('N2O Concentrations for 2003-2005',
                    'N2O Concentrations for 2005-2007',
                    'N2O Concentrations for 2007-2009',
                    'N2O Concentrations for 2009-2011',
                    'N2O Concentrations for 2011-2013',
                    'N2O Concentrations for 2013-2015',
                    'N2O Concentrations for 2015-2017',
                    'N2O Concentrations for 2017-2019',
                    'N2O Concentrations for 2019-2021')

ggarrange(plotlist = block_list,
          ncol = 3, nrow = 3, 
          labels = block.names,
          hjust = -.2555,
          vjust = 1.5)
```

When broken up, it's a little easier to compare pre/post COVID trends. SF6 looks a little smoother within the post-COVID window. CH4 follows similar patterns within each window, but there seems to be a more dramatic dip during the post-COVID month of March 2021. N2O shows a similar trend to SF6, with a smoother plot and less dramatic spike during the COVID window.

Sometimes it can be difficult to show very small changes along a large time frame using just a line. In this case, other, more visually nuanced plots can come in handy. Let's check out heat maps for the gas concentration data: 

```{r,class.source = "fold-show", fig.cap = "Gas Heat Maps"}
#---------------Heat Map(s)-----------------------------
######################### SF6 #########################
sf6_heat.plot <-ggplot(big.sf6_full,aes(x = Year, y= Month, fill=Average_ppb))+
  geom_tile(color= "white",size=0.1) + 
  scale_fill_viridis(name="Average_ppb",option ="C", discrete = FALSE)
sf6_heat.plot <-sf6_heat.plot + scale_y_continuous(trans = "reverse", breaks = unique(big.gas_full$sf6))
sf6_heat.plot <-sf6_heat.plot + scale_y_continuous(breaks =c(1:12))
sf6_heat.plot <-sf6_heat.plot + theme_minimal(base_size = 8)
sf6_heat.plot <-sf6_heat.plot + labs(title= paste("SF6 Concentration"), x="Year", y="Month")
sf6_heat.plot <-sf6_heat.plot + theme(legend.position = "bottom")+
  theme(plot.title=element_text(size = 14))+
  theme(axis.text.y=element_text(size=10)) +
  theme(strip.background = element_rect(colour="white"))+
  theme(plot.title=element_text(hjust=0))+
  theme(axis.ticks=element_blank())+
  theme(axis.text=element_text(size=10))+
  theme(legend.title=element_text(size=10))+
  theme(legend.text=element_text(size=8)) +
  theme(legend.key.width = unit(1, 'cm'))

######################### CH4 #########################
ch4_heat.plot <-ggplot(big.ch4_full,aes(x = Year, y= Month, fill=Average_ppb))+
  geom_tile(color= "white",size=0.1) + 
  scale_fill_viridis(name="Average_ppb",option ="C", discrete = FALSE)
ch4_heat.plot <-ch4_heat.plot + scale_y_continuous(trans = "reverse", breaks = unique(big.gas_full$ch4))
ch4_heat.plot <-ch4_heat.plot + scale_y_continuous(breaks =c(1:12))
ch4_heat.plot <-ch4_heat.plot + theme_minimal(base_size = 8)
ch4_heat.plot <-ch4_heat.plot + labs(title= paste("CH4 Concentration"), x="Year", y="Month")
ch4_heat.plot <-ch4_heat.plot + theme(legend.position = "bottom")+
  theme(plot.title=element_text(size = 14))+
  theme(axis.text.y=element_text(size=10)) +
  theme(strip.background = element_rect(colour="white"))+
  theme(plot.title=element_text(hjust=0))+
  theme(axis.ticks=element_blank())+
  theme(axis.text=element_text(size=10))+
  theme(legend.title=element_text(size=10))+
  theme(legend.text=element_text(size=8)) +
  theme(legend.key.width = unit(1, 'cm'))

######################### N2o #########################
n2o_heat.plot <-ggplot(big.n2o_full,aes(x = Year, y= Month, fill=Average_ppb))+
  geom_tile(color= "white",size=0.1) + 
  scale_fill_viridis(name="Average_ppb",option ="C", discrete = FALSE)
n2o_heat.plot <-n2o_heat.plot + scale_y_continuous(trans = "reverse", breaks = unique(big.gas_full$n2o))
n2o_heat.plot <-n2o_heat.plot + scale_y_continuous(breaks =c(1:12))
n2o_heat.plot <-n2o_heat.plot + theme_minimal(base_size = 8)
n2o_heat.plot <-n2o_heat.plot + labs(title= paste("N2O Concentration"), x="Year", y="Month")
n2o_heat.plot <-n2o_heat.plot + theme(legend.position = "bottom")+
  theme(plot.title=element_text(size = 14))+
  theme(axis.text.y=element_text(size=10)) +
  theme(strip.background = element_rect(colour="white"))+
  theme(plot.title=element_text(hjust=0))+
  theme(axis.ticks=element_blank())+
  theme(axis.text=element_text(size=10))+
  theme(legend.title=element_text(size=10))+
  theme(legend.text=element_text(size=8)) +
  theme(legend.key.width = unit(1, 'cm'))


######################## Moment of Truth ###############
ggplotly(sf6_heat.plot)
ggplotly(ch4_heat.plot)
ggplotly(n2o_heat.plot)


## Big Boy---------
# lapply(big.gas_full$gas, function(x) {
#   gg <- ggplot(filter(big.gas_full, gas==x),
#                aes(x=Year, y=Month, fill=Average_ppb, frame=gas))
#   gg <- gg + geom_tile(color="white", linewidth=0.1)
#   gg <- gg + scale_x_discrete(expand=c(0,0))
#   gg <- gg + scale_y_discrete(expand=c(0,0))
#   gg <- gg + scale_fill_viridis(name="")
#   gg <- gg + coord_equal()
#   gg <- gg + labs(x="Year", y="Month",
#                   title=sprintf("%s", x))
#   gg <- gg + theme_tufte()
#   gg <- gg + theme(axis.ticks=element_blank())
#   gg <- gg + theme(axis.text=element_text(size=5))
#   gg <- gg + theme(panel.border=element_blank())
#   gg <- gg + theme(plot.title=element_text(hjust=0, size=6))
#   gg <- gg + theme(panel.spacing.x=unit(0.5, "cm"))
#   gg <- gg + theme(panel.spacing.y=unit(0.5, "cm"))
#   gg <- gg + theme(legend.title=element_text(size=6))
#   gg <- gg + theme(legend.title.align=1)
#   gg <- gg + theme(legend.text=element_text(size=6))
#   gg <- gg + theme(legend.position="bottom")
#   gg <- gg + theme(legend.key.size=unit(0.2, "cm"))
#   gg <- gg + theme(legend.key.width=unit(1, "cm"))
#   gg
# }) -> cclist
# 
# cclist[["ncol"]] <- 1
# 
# do.call(grid.arrange, cclist)

combined_heat.plot <- plot_grid(sf6_heat.plot,
          ch4_heat.plot,
          n2o_heat.plot,
          labels = c("A", "B", "C"),
          ncol = 1,
          nrow = 3)

combined_heat.plot

```     

The heat maps provide a little more dimensionality as well to our understanding of the data. Besides the upward trend in gas concentration along each year, we can see that the later months of each year seem to have higher levels than earlier months of the same year. Comparing windows as well, CH4 seems to have a little more of a dramatic change in concentration during the COVID window than among previous years/windows.

########################################### BREAK IN LOGAN'S ADDITIONS ###################################

## Gas atmospheric concentration predictions
```{r}
# CH4
# Post-editorial note: originally, we converted everything to ppb
# We later decided to undo this, but some of our plots still use ppb
# Therefore, I am manually changing the ppm and ppt columns to ppb
colnames(gas.data[[1]])[which(colnames(gas.data[[1]]) == "Average_ppm")] <- "Average_ppb"
gas.data[[1]]$Average_ppb <- gas.data[[1]]$Average_ppb * 1000
ch4 <- as.data.frame(gas.data[1])
# colnames(ch4)[which(colnames(ch4) == "ch4.Average_ppm")] <- "Average_ppb"
# ch4$Average_ppb <- ch4$Average_ppb * 1000
names(ch4) <- gsub('ch4.', "", names(ch4))

# make ch4 dataframes (18 mos)
ch4 <- df_window_subset(ch4)

ch4_1 <- as.data.frame(ch4[1])
ch4_2 <- as.data.frame(ch4[2])
ch4_3 <- as.data.frame(ch4[3])
ch4_4 <- as.data.frame(ch4[4])
ch4_5 <- as.data.frame(ch4[5])
ch4_6 <- as.data.frame(ch4[6])
ch4_7 <- as.data.frame(ch4[7])
ch4_8 <- as.data.frame(ch4[8])
ch4_9 <- as.data.frame(ch4[9])

# fix col names
names(ch4_1) <- substring(names(ch4_1), 12)
names(ch4_2) <- substring(names(ch4_2), 12)
names(ch4_3) <- substring(names(ch4_3), 12)
names(ch4_4) <- substring(names(ch4_4), 12)
names(ch4_5) <- substring(names(ch4_5), 12)
names(ch4_6) <- substring(names(ch4_6), 12)
names(ch4_7) <- substring(names(ch4_7), 12)
names(ch4_8) <- substring(names(ch4_8), 12)
names(ch4_9) <- substring(names(ch4_9), 12)

# add dates
ch4_1 <- add_date_col(ch4_1)
ch4_2 <- add_date_col(ch4_2)
ch4_3 <- add_date_col(ch4_3)
ch4_4 <- add_date_col(ch4_4)
ch4_5 <- add_date_col(ch4_5)
ch4_6 <- add_date_col(ch4_6)
ch4_7 <- add_date_col(ch4_7)
ch4_8 <- add_date_col(ch4_8)
ch4_9 <- add_date_col(ch4_9)

# make one df
ch4_df <- rbind(ch4_1, ch4_2, ch4_3, ch4_4, ch4_5, ch4_6, ch4_7, ch4_8, ch4_9)
ch4_df$Period <- NA
ch4_df$Period[1:20] <- "Dec '03 - July '05"
ch4_df$Period[21:40] <- "Dec '05 - July '07"
ch4_df$Period[41:60] <- "Dec '07 - July '09"
ch4_df$Period[61:80] <- "Dec '09 - July '11"
ch4_df$Period[81:100] <- "Dec '11 - July '13"
ch4_df$Period[101:120] <- "Dec '13 - July '15"
ch4_df$Period[121:140] <- "Dec '15 - July '17"
ch4_df$Period[141:160] <- "Dec '17 - July '19"
ch4_df$Period[161:180] <- "Dec '19 - July '21"

# calculate mean over 18 mo periods
ch4_periods <- c(1,2,3,4,5,6,7,8,9)
ch4_period_names <- names(ch4)
ch4_period_means <- c(mean(ch4_1$Average_ppb), mean(ch4_2$Average_ppb), mean(ch4_3$Average_ppb),
                  mean(ch4_4$Average_ppb), mean(ch4_5$Average_ppb), mean(ch4_6$Average_ppb),
                  mean(ch4_7$Average_ppb), mean(ch4_8$Average_ppb), mean(ch4_9$Average_ppb))

ch4_period_df <- data.frame(ch4_periods, ch4_period_names, ch4_period_means)




# N2O
n2o <- as.data.frame(gas.data[2])
names(n2o) <- gsub('n2o.', "", names(n2o))

# make n2o dataframes (18 mos)
n2o <- df_window_subset(n2o)

n2o_1 <- as.data.frame(n2o[1])
n2o_2 <- as.data.frame(n2o[2])
n2o_3 <- as.data.frame(n2o[3])
n2o_4 <- as.data.frame(n2o[4])
n2o_5 <- as.data.frame(n2o[5])
n2o_6 <- as.data.frame(n2o[6])
n2o_7 <- as.data.frame(n2o[7])
n2o_8 <- as.data.frame(n2o[8])
n2o_9 <- as.data.frame(n2o[9])

# fix col names
names(n2o_1) <- substring(names(n2o_1), 12)
names(n2o_2) <- substring(names(n2o_2), 12)
names(n2o_3) <- substring(names(n2o_3), 12)
names(n2o_4) <- substring(names(n2o_4), 12)
names(n2o_5) <- substring(names(n2o_5), 12)
names(n2o_6) <- substring(names(n2o_6), 12)
names(n2o_7) <- substring(names(n2o_7), 12)
names(n2o_8) <- substring(names(n2o_8), 12)
names(n2o_9) <- substring(names(n2o_9), 12)

# add dates
n2o_1 <- add_date_col(n2o_1)
n2o_2 <- add_date_col(n2o_2)
n2o_3 <- add_date_col(n2o_3)
n2o_4 <- add_date_col(n2o_4)
n2o_5 <- add_date_col(n2o_5)
n2o_6 <- add_date_col(n2o_6)
n2o_7 <- add_date_col(n2o_7)
n2o_8 <- add_date_col(n2o_8)
n2o_9 <- add_date_col(n2o_9)

# make one df
n2o_df <- rbind(n2o_1, n2o_2, n2o_3, n2o_4, n2o_5, n2o_6, n2o_7, n2o_8, n2o_9)
n2o_df$Period <- NA
n2o_df$Period[1:20] <- "Dec '03 - July '05"
n2o_df$Period[21:40] <- "Dec '05 - July '07"
n2o_df$Period[41:60] <- "Dec '07 - July '09"
n2o_df$Period[61:80] <- "Dec '09 - July '11"
n2o_df$Period[81:100] <- "Dec '11 - July '13"
n2o_df$Period[101:120] <- "Dec '13 - July '15"
n2o_df$Period[121:140] <- "Dec '15 - July '17"
n2o_df$Period[141:160] <- "Dec '17 - July '19"
n2o_df$Period[161:180] <- "Dec '19 - July '21"

# calculate mean over 18 mo periods
n2o_periods <- c(1,2,3,4,5,6,7,8,9)
n2o_period_names <- names(n2o)
n2o_period_means <- c(mean(n2o_1$Average_ppb), mean(n2o_2$Average_ppb), mean(n2o_3$Average_ppb),
                      mean(n2o_4$Average_ppb), mean(n2o_5$Average_ppb), mean(n2o_6$Average_ppb),
                      mean(n2o_7$Average_ppb), mean(n2o_8$Average_ppb), mean(n2o_9$Average_ppb))

n2o_period_df <- data.frame(n2o_periods, n2o_period_names, n2o_period_means)




# SF6
colnames(gas.data[[3]])[which(colnames(gas.data[[3]]) == "Average_ppt")] <- "Average_ppb"
gas.data[[3]]$Average_ppb <- gas.data[[3]]$Average_ppb / 1000
sf6 <- as.data.frame(gas.data[3])
names(sf6) <- gsub('sf6.', "", names(sf6))

# make sf6 dataframes (18 mos)
sf6 <- df_window_subset(sf6)

sf6_1 <- as.data.frame(sf6[1])
sf6_2 <- as.data.frame(sf6[2])
sf6_3 <- as.data.frame(sf6[3])
sf6_4 <- as.data.frame(sf6[4])
sf6_5 <- as.data.frame(sf6[5])
sf6_6 <- as.data.frame(sf6[6])
sf6_7 <- as.data.frame(sf6[7])
sf6_8 <- as.data.frame(sf6[8])
sf6_9 <- as.data.frame(sf6[9])

# fix col names
names(sf6_1) <- substring(names(sf6_1), 12)
names(sf6_2) <- substring(names(sf6_2), 12)
names(sf6_3) <- substring(names(sf6_3), 12)
names(sf6_4) <- substring(names(sf6_4), 12)
names(sf6_5) <- substring(names(sf6_5), 12)
names(sf6_6) <- substring(names(sf6_6), 12)
names(sf6_7) <- substring(names(sf6_7), 12)
names(sf6_8) <- substring(names(sf6_8), 12)
names(sf6_9) <- substring(names(sf6_9), 12)

# add dates
sf6_1 <- add_date_col(sf6_1)
sf6_2 <- add_date_col(sf6_2)
sf6_3 <- add_date_col(sf6_3)
sf6_4 <- add_date_col(sf6_4)
sf6_5 <- add_date_col(sf6_5)
sf6_6 <- add_date_col(sf6_6)
sf6_7 <- add_date_col(sf6_7)
sf6_8 <- add_date_col(sf6_8)
sf6_9 <- add_date_col(sf6_9)

# make one df
sf6_df <- rbind(sf6_1, sf6_2, sf6_3, sf6_4, sf6_5, sf6_6, sf6_7, sf6_8, sf6_9)
sf6_df$Period <- NA
sf6_df$Period[1:20] <- "Dec '03 - July '05"
sf6_df$Period[21:40] <- "Dec '05 - July '07"
sf6_df$Period[41:60] <- "Dec '07 - July '09"
sf6_df$Period[61:80] <- "Dec '09 - July '11"
sf6_df$Period[81:100] <- "Dec '11 - July '13"
sf6_df$Period[101:120] <- "Dec '13 - July '15"
sf6_df$Period[121:140] <- "Dec '15 - July '17"
sf6_df$Period[141:160] <- "Dec '17 - July '19"
sf6_df$Period[161:180] <- "Dec '19 - July '21"

# caculate mean over 18 mo periods
sf6_periods <- c(1,2,3,4,5,6,7,8,9)
sf6_period_names <- names(sf6)
sf6_period_means <- c(mean(sf6_1$Average_ppb), mean(sf6_2$Average_ppb), mean(sf6_3$Average_ppb),
                      mean(sf6_4$Average_ppb), mean(sf6_5$Average_ppb), mean(sf6_6$Average_ppb),
                      mean(sf6_7$Average_ppb), mean(sf6_8$Average_ppb), mean(sf6_9$Average_ppb))

sf6_period_df <- data.frame(sf6_periods, sf6_period_names, sf6_period_means)


############################################################################

# make data frames with every month 12/03-07/22

ch4_nonperiod <- as.data.frame(gas.data[1])

names(ch4_nonperiod) <- gsub('ch4.', "", names(ch4_nonperiod))

n2o_nonperiod <- as.data.frame(gas.data[2])

names(n2o_nonperiod) <- gsub('n2o.', "", names(n2o_nonperiod))

sf6_nonperiod <- as.data.frame(gas.data[3])

names(sf6_nonperiod) <- gsub('sf6.', "", names(sf6_nonperiod))

```

We developed boxplots to explore the overall distribution of the gas data for each 20 month period that we defined earlier.      

```{r, fig.width = 10, fig.fig.height = 10, fig.cap = "Boxplots displaying distribution of mole fraction data for the indicated 20 month windows for each of methane (top left), nitrous oxide (top right), and sulfur hexafluoride (bottom left). PPB = parts per billion."}
theme_bluewhite <- function(base_size = 11, base_family = "") {
  theme_bw() %+replace% 
    theme(
      panel.grid.major  = element_line(color = "white"),
      panel.background = element_rect(fill = "lightblue"),
      panel.border = element_rect(color = "lightblue", fill = NA),
      axis.line = element_line(color = "lightblue"),
      axis.ticks = element_line(color = "lightblue"),
      axis.text = element_text(color = "steelblue")
    )
}

a <- ggplot(ch4_df) + 
  geom_boxplot(aes(x = as.factor(Period), y = Average_ppb)) + 
  labs(title = "CH4") + xlab("20 Month Period") + ylab("PPB") + 
  theme_bluewhite() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.5,
      vjust = .5
    ))

b <- ggplot(n2o_df) + 
  geom_boxplot(aes(x = as.factor(Period), y = Average_ppb)) + 
  labs(title = "N2O") + xlab("20 Month Period") + ylab("PPB") + 
  theme_bluewhite() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.5,
      vjust = .5
    ))

c <- ggplot(sf6_df) + 
  geom_boxplot(aes(x = as.factor(Period), y = Average_ppb)) + 
  labs(title = "SF6") + xlab("20 Month Period") + ylab("PPB") + 
  theme_bluewhite() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.5,
      vjust = .5
    ))

plot_grid(a, b, c)

```

We noticed a generally linear increase in the central tendency of the distributions as we progressed through each 20 month period. Therefore, we were interested in exploring global greenhouse gas concentration trends through a linear model. In particular, we wanted to understand how the COVID-19-induced changes in gas atmospheric concentrations potentially perturbed linear increases in these concentrations. Therefore, linear models were created with and without the COVID-19 period to see how temperature predictions were perturbed by this short-term period of decrease human activity.

```{r message = F, fig.width = 10, fig.height = 10, fig.cap = "Linear models fit across monthly average gas concentration data with the defined COVID-19 period of December 2019 - July 2021 (blue line), and without the COVID-19 period (red line) extrapolated to 2050 for each of the three indicated greenhouse gases. Black dots indicate actual concentration data. Shaded areas around each line indicates the 95% confidence interval for the true regression line. PPB = parts per billion."}
x <- ggplot() +
  geom_point(data = ch4_nonperiod[12:218,], aes(x = Year_Day_decimal, y = Average_ppb))+
  geom_smooth(data = ch4_df, aes(x = Year_Day_decimal, y = Average_ppb, col = "With Covid Period"), method = "lm", 
              fullrange = TRUE) +
  geom_smooth(data = ch4_df[1:160, ], aes(x = Year_Day_decimal, y = Average_ppb, col = "Without Covid Period"),
              method = "lm", fullrange=TRUE) + xlim(c(2003,2050)) + 
  xlab("Year") + ylab("PPB") + ggtitle("CH4") +
  scale_color_manual(name='Linear Trend', breaks=c('With Covid Period', 'Without Covid Period'),
                     values=c('With Covid Period'='blue', 'Without Covid Period'='red'))


y <- ggplot() +
  geom_point(data = n2o_nonperiod[12:218,], aes(x = Year_Day_decimal, y = Average_ppb))+
  geom_smooth(data = n2o_df, aes(x = Year_Day_decimal, y = Average_ppb, col = "With Covid Period"), method = "lm", 
              fullrange = TRUE) +
  geom_smooth(data = n2o_df[1:160, ], aes(x = Year_Day_decimal, y = Average_ppb, col = "Without Covid Period"),
              method = "lm", fullrange=TRUE) + xlim(c(2003,2050)) + 
  xlab("Year") + ylab("PPB") + ggtitle("N2O") +
  scale_color_manual(name='Linear Trend', breaks=c('With Covid Period', 'Without Covid Period'),
                     values=c('With Covid Period'='blue', 'Without Covid Period'='red'))


z <- ggplot() +
  geom_point(data = sf6_nonperiod[12:218,], aes(x = Year_Day_decimal, y = Average_ppb))+
  geom_smooth(data = sf6_df, aes(x = Year_Day_decimal, y = Average_ppb, col = "With Covid Period"), method = "lm", 
              fullrange = TRUE) +
  geom_smooth(data = sf6_df[1:160, ], aes(x = Year_Day_decimal, y = Average_ppb, col = "Without Covid Period"),
              method = "lm", fullrange=TRUE) + xlim(c(2003,2050)) + 
  xlab("Year") + ylab("PPB") + ggtitle("SF6") +
  scale_color_manual(name='Linear Trend', breaks=c('With Covid Period', 'Without Covid Period'),
                     values=c('With Covid Period'='blue', 'Without Covid Period'='red'))

plot_grid(x,y,z)

```
Below are the regression line formulas used to calculate the 2050 PPB prediction with and without the Covid period. The results of the linear model were opposite to what we expected. Removing the Covid period increased the predicted PPB across the board for our three greenhouse gasses of interest.

```{r, message=FALSE}
# 2050 predictions
options(scipen=999)

#ch4 with covid
lm <- lm(formula = ch4_df$Average_ppb ~ ch4_df$Year_Day_decimal)

#ch4 without covid
lm_wo <- lm(formula = ch4_df[1:160, ]$Average_ppb ~ ch4_df[1:160, ]$Year_Day_decimal)

#n2o with covid
lm1 <- lm(formula = n2o_df$Average_ppb ~ n2o_df$Year_Day_decimal)

# n2o without covid
lm1_wo <- lm(formula = n2o_df[1:160, ]$Average_ppb ~ n2o_df[1:160, ]$Year_Day_decimal)

# sf6 with covid
lm2 <- lm(formula = sf6_df$Average_ppb ~ sf6_df$Year_Day_decimal)

# sf6 without covid
lm2_wo <- lm(formula = sf6_df[1:160, ]$Average_ppb ~ sf6_df[1:160, ]$Year_Day_decimal)
```

CH4 prediction with covid period: `r round(lm$coefficients[1] + (lm$coefficients[2] * 2050.5), 3)` ppb.

CH4 prediction without covid period: `r round(lm_wo$coefficients[1] + (lm_wo$coefficients[2] * 2050.5), 3)` ppb.

N2O prediction with covid period: `r round(lm1$coefficients[1] + (lm1$coefficients[2] * 2050.5), 3)` ppb.

N2O prediction without covid period: `r round(lm1_wo$coefficients[1] + (lm1_wo$coefficients[2] * 2050.5), 3) ppb.

SF6 prediction with covid period: `r round(lm2$coefficients[1] + (lm2$coefficients[2] * 2050.5), 3) ppb

SF6 prediction without covid period: `r round(lm2_wo$coefficients[1] + (lm2_wo$coefficients[2] * 2050.5), 3)` ppb.

################################################# LOGAN'S MOVING AVERAGES ######################################
A moving average is taken by finding the averages of certain defined subsets within a dataset. With each progressive calculation, the "first" element of each subset is replaced by the "next" element in the defined subset list. This can be useful when trying to ascertain the trend shifts in data and smooth out potentially volatile data sets.

There are several different types of moving averages, but for my next few plots I want to define only two:

The first is the simple moving average (SMA), where a defined number of entries are added together and divided by the entry count. The subset can be defined differently depending on what's needed, but in this case the subset it used by treating each x-value as the median value for its subset. 

The second is the Double Exponential Moving Average (DEMA). This is more complex, but is also more sensitive to recent changes in the data. Its calculation is a little complicated, but essentially you perform a weighted SMA that is smoothed by subtracting the weighted SMA of that trend from double the original moving average. Convoluted? Yes. Responsive? Very.

```{r,class.source = "fold-show", fig.cap = "Moving Averages"}
#---------------------Moving Average-------------------

##################### sf6 rate of change ###############
sf6_full.sub_list <- c(big.sf6_full$Average_ppb[-1],last(big.sf6_full$Average_ppb))
big.sf6_full$avg_change <- sf6_full.sub_list - big.sf6_full$Average_ppb

sf6.rate_of_change <- big.sf6_full %>%
  ggplot(aes(x = Date, y = avg_change)) +
  #geom_line() + 
  geom_ma(color = "blue", ma_fun = SMA, n = 20, linetype = "solid") +# Plot windowed SMA
  geom_ma(ma_fun = DEMA, n = 20, color = "red", linetype = "longdash") + #Plot windowed DEMA+
  scale_x_date(date_breaks = "20 months", date_labels = "%Y %b %d") +
  coord_x_date(xlim = c("2003-12-01", "2021-07-01")) + # Zoom in
  labs(x = "Year", y = "Average Change (ppb)", 
       title = "Average Monthly SF6 Changes From 2003 - 2021",
       subtitle = "Blue = SMA, Red = DEMA, n = 20") +
  theme_minimal(base_line_size = .05) +
  theme(text = element_text(size = 16),
        axis.text.x=element_text(angle=60, hjust=1))


#sf6.rate_of_change
##################### ch4 rate of change ###############
ch4_full.sub_list <- c(big.ch4_full$Average_ppb[-1],last(big.ch4_full$Average_ppb))
big.ch4_full$avg_change <- ch4_full.sub_list - big.ch4_full$Average_ppb

ch4.rate_of_change <- big.ch4_full %>%
  ggplot(aes(x = Date, y = avg_change)) +
  #geom_line() + 
  geom_ma(color = "blue", ma_fun = SMA, n = 20, linetype = "solid") +# Plot windowed SMA
  geom_ma(ma_fun = DEMA, n = 20, color = "red", linetype = "longdash") + #Plot windowed DEMA
  scale_x_date(date_breaks = "20 months", date_labels = "%Y %b %d") +
  coord_x_date(xlim = c("2003-12-01", "2021-07-01")) + # Zoom in
  labs(x = "Year", y = "Average Change (ppb)", 
       title = "Average Monthly CH4 Changes From 2003 - 2021",
       subtitle = "Blue = SMA, Red = DEMA, n = 20") +
  theme_minimal(base_line_size = .05) +
  theme(text = element_text(size = 16),
        axis.text.x=element_text(angle=60, hjust=1))


#ch4.rate_of_change


##################### N2O rate of change ###############
n2o_full.sub_list <- c(big.n2o_full$Average_ppb[-1],last(big.n2o_full$Average_ppb))
big.n2o_full$avg_change <- n2o_full.sub_list - big.n2o_full$Average_ppb

n2o.rate_of_change <- big.n2o_full %>%
  ggplot(aes(x = Date, y = avg_change)) +
  #geom_line() + 
  geom_ma(color = "blue", ma_fun = SMA, n = 20, linetype = "solid") +# Plot windowed SMA
  geom_ma(ma_fun = DEMA, n = 20, color = "red", linetype = "longdash") + #Plot windowed DEMA
  scale_x_date(date_breaks = "20 months", date_labels = "%Y %b %d") +
  coord_x_date(xlim = c("2003-12-01", "2021-07-01")) + # Zoom in
  labs(x = "Year", y = "Average Change (ppb)", 
       title = "Average Monthly N2O Changes From 2003 - 2021",
       subtitle = "Blue = SMA, Red = DEMA, n = 20") +
  theme_minimal(base_line_size = .05) +
  theme(text = element_text(size = 16),
        axis.text.x=element_text(angle=60, hjust=1))


#n2o.rate_of_change

plot_grid(sf6.rate_of_change, ch4.rate_of_change, n2o.rate_of_change)
```

So, we can see that each of the gases have their own fluctuations in rate of change over time. SF6 shows a bit more of an upward trend marked by a few dips, whereas CH4 and N2o tend to bounce around a central value. There weren't any glaring differences among the COVID windows, but SF6 and N2O had somewhat irregular dips around the time of the first reported COVID case.
######################### END LOGAN'S ADDITIONS #########################################

## NASA Temp Data: Clustering and Correlation


# References {-}